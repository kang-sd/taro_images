<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jennifer Canvas | AI íƒ€ë¡œ</title>

  <style>
    :root { --gold: #c5a059; --bg: #f8f9fa; --white: #ffffff; --text: #333; }
    body { background:var(--bg); color:var(--text); font-family:'Apple SD Gothic Neo','Malgun Gothic',sans-serif; margin:0; display:flex; justify-content:center; min-height:100vh; }
    .glass-panel { background:var(--white); border-radius:30px; padding:30px; box-shadow:0 20px 60px rgba(0,0,0,0.05); width:95vw; max-width:550px; margin:25px auto; text-align:center; position:relative; }
    .header { display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f1f1; padding-bottom:15px; margin-bottom:25px; }
    .title-text { font-size:1.4rem; font-weight:800; color:var(--gold); letter-spacing:1px; }
    .page { display:none; animation:fadeIn 0.5s ease; }
    .page.active { display:block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .intro-grid { display:flex; gap:15px; text-align:left; background:#fffcf5; padding:20px; border-radius:20px; margin-bottom:25px; border:1px solid #eee; }
    .main-img { width:100px; border-radius:10px; flex-shrink:0; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
    .intro-text { font-size:0.88rem; line-height:1.6; color:#555; }
    .hl-red  { color:#d9534f; font-weight:bold; }
    .hl-blue { color:#4a90e2; font-weight:bold; }
    input,select,textarea { width:100%; padding:15px; border-radius:12px; background:#fff; border:1px solid #ddd; margin-bottom:15px; box-sizing:border-box; font-size:1rem; color:#333; }
    input:focus,select:focus,textarea:focus { outline:none; border-color:var(--gold); box-shadow:0 0 0 3px rgba(197,160,89,0.1); }
    .btn { background:linear-gradient(135deg,#c5a059,#e2c285); color:#fff; border:none; padding:18px; border-radius:50px; width:100%; font-weight:bold; cursor:pointer; font-size:1.15rem; transition:all 0.3s ease; margin-bottom:10px; box-shadow:0 5px 15px rgba(197,160,89,0.3); }
    .btn:hover   { transform:translateY(-2px); box-shadow:0 8px 20px rgba(197,160,89,0.4); }
    .btn:active  { transform:translateY(0); }
    .btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
    .card-slots { display:flex; justify-content:center; gap:20px; margin:30px 0; }
    .card-box { width:130px; height:230px; border-radius:15px; cursor:pointer; background:url('https://kang-sd.github.io/taro_images/card_back.webp') center/cover; border:1px solid #eee; transition:all 0.6s ease; box-shadow:0 10px 20px rgba(0,0,0,0.1); }
    .card-box:hover  { transform:scale(1.05); }
    .card-box.flipped { transform:rotateY(180deg); border-color:var(--gold); box-shadow:0 0 30px rgba(197,160,89,0.5); }
    .res-card { background:#fff; border-radius:20px; padding:25px; margin-bottom:25px; border:1px solid #f1f1f1; text-align:left; position:relative; box-shadow:0 5px 15px rgba(0,0,0,0.03); }
    .res-img { width:90px; border-radius:10px; float:right; margin-left:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
    .d-label { color:var(--gold); font-size:0.85rem; margin-top:15px; font-weight:bold; border-bottom:1px solid #f1f1f1; padding-bottom:5px; }
    .d-content { font-size:0.95rem; line-height:1.6; margin-top:8px; color:#444; }
    #adminModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; overflow-y:auto; box-sizing:border-box; }
    #resultModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; overflow-y:auto; padding:20px; box-sizing:border-box; }
    #resultModalContent { background:white; max-width:600px; margin:30px auto; border-radius:20px; padding:30px; position:relative; }
    .admin-record { background:#f9f9f9; padding:15px; border-radius:15px; margin-bottom:10px; border:1px solid #eee; }
    .admin-btn { padding:8px 15px; border:none; border-radius:8px; cursor:pointer; font-size:0.85rem; margin-right:5px; transition:all 0.2s; font-weight:bold; }
    .admin-btn:hover { transform:translateY(-1px); }
    .btn-view   { background:#4a90e2; color:white; }
    .btn-delete { background:#ff5a5a; color:white; }
    @media print { .btn,.header,#adminModal,#resultModal{display:none!important} body{background:white} .glass-panel{box-shadow:none;border:none;width:100%;max-width:none;margin:0} }
  </style>
</head>
<body>

<div class="glass-panel" id="captureArea">
  <div class="header">
    <span style="font-size:1.6rem;">â˜€ï¸</span>
    <span class="title-text">JENNIFER CANVAS</span>
    <span style="cursor:pointer; font-size:1.3rem; color:#ccc;" onclick="openAdmin()">âš™ï¸</span>
  </div>

  <!-- 1ë‹¨ê³„: ì…ë ¥ -->
  <div id="p1" class="page active">
    <div class="intro-grid">
      <img src="https://kang-sd.github.io/taro_images/card_0.webp" class="main-img" alt="íƒ€ë¡œ ì¹´ë“œ">
      <div class="intro-text">
        <span class="hl-red">íƒ€ë¡œë€?</span><br>
        íƒ€ë¡œë€ ìƒì§•ì˜ ì¹´ë“œë¡œ ë‚´ë©´ê³¼ ê°ì •ì˜ íë¦„ì„ ë¹„ì¶”ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.<br>
        <span class="hl-red">ì§ˆë¬¸ì€.</span> <span class="hl-blue">ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ì§ˆë¬¸ì„ í•˜ëŠ” ê²ƒì´ íƒ€ë¡œ ì§„í–‰ì˜ ì •í™•ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.</span><br>
        <span class="hl-red">ë‹¹ì‹ ì˜ ë§ˆìŒê³¼ ì§ˆë¬¸ì´ ê°„ì ˆí•  ë•Œ</span> <span class="hl-blue">ë°©í–¥ì„ ì œì‹œí•©ë‹ˆë‹¤.</span><br>
        í•˜ë£¨ 2ë²ˆ ê°€ëŠ¥, ê²°ê³¼ëŠ” 3ì¼ê°„ ì €ì¥ í›„ ê²€ìƒ‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br><br>
        <span class="hl-red">ì´ 2ì¥ì„ ì„ íƒí•©ë‹ˆë‹¤.</span><br>
        [ê³¼ì •ì˜ íë¦„]ê³¼ [ê²°ê³¼]ë¥¼ ìˆœì„œëŒ€ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
      </div>
    </div>
    <input type="text" id="uName" placeholder="ì„±í•¨ì„ ì…ë ¥í•˜ì„¸ìš”">
    <select id="uTopic">
      <option value="" disabled selected hidden>-- ìƒë‹´ ì£¼ì œ ì„ íƒ --</option>
      <option>ì—°ì• </option><option>ì§„ë¡œì§ì—…</option><option>ê¸ˆì „</option>
      <option>ê°ì •</option><option>ê±´ê°•</option><option>ì‹œí—˜í•©ê²©</option>
      <option>ì„ íƒê²°ì •</option><option>ì¸ê°„ê´€ê³„</option><option>ì˜ì  ë©”ì‹œì§€</option><option>ë¯¸ë˜ ì „ë°˜</option>
    </select>
    <textarea id="uQuest" rows="2" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <button class="btn" id="startBtn" onclick="checkLimitAndGo()">ì…”í”Œ ì‹œì‘í•˜ê¸°</button>
  </div>

  <!-- 2ë‹¨ê³„: ì¹´ë“œ ì„ íƒ -->
  <div id="p2" class="page">
    <h3 style="color:var(--gold);">ì¹´ë“œë¥¼ ë‘ ì¥ ì„ íƒí•˜ì„¸ìš”.</h3>
    <div class="card-slots">
      <div id="slot1" class="card-box" onclick="flip(1)"></div>
      <div id="slot2" class="card-box" onclick="flip(2)"></div>
    </div>
    <p id="guide" style="color:#aaa; font-weight:bold;">ì²« ë²ˆì§¸ ì¹´ë“œë¥¼ ê³ ë¥´ì„¸ìš”</p>
    <button class="btn" id="resBtn" style="display:none;" onclick="go3()">í•´ì„ ê²°ê³¼ í™•ì¸</button>
  </div>

  <!-- 3ë‹¨ê³„: ê²°ê³¼ -->
  <div id="p3" class="page">
    <div id="finalOutput"></div>
    <button class="btn" onclick="window.print()" style="background:#28a745;">ğŸ’¾ ê²°ê³¼ ì €ì¥ (PDF/ì´ë¯¸ì§€)</button>
    <button class="btn" onclick="location.reload()" style="background:#eee; color:#666;">ì²˜ìŒìœ¼ë¡œ</button>
  </div>
</div>

<!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
<div id="adminModal">
  <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:15px; margin-bottom:20px;">
    <h2 style="margin:0; color:var(--gold);">ğŸ“‚ ìƒë‹´ ê¸°ë¡ ê´€ë¦¬</h2>
    <button class="btn" style="width:100px; margin:0; padding:10px;" onclick="closeAdmin()">ë‹«ê¸°</button>
  </div>
  <div id="adminList" style="text-align:left;"></div>
</div>

<!-- ê²°ê³¼ ëª¨ë‹¬ -->
<div id="resultModal" onclick="closeResult(event)">
  <div id="resultModalContent" onclick="event.stopPropagation()">
    <button onclick="closeResult()" style="position:absolute; top:15px; right:15px; background:#eee; border:none; width:35px; height:35px; border-radius:50%; cursor:pointer; font-size:1.3rem; color:#666;">Ã—</button>
    <div id="modalResultContent"></div>
  </div>
</div>

<script>
  // âœ… Cloud Functions ë² ì´ìŠ¤ URL â€” ë°°í¬ í›„ ì‹¤ì œ URLë¡œ êµì²´
  const FN = "https://us-central1-taro-project-624a3.cloudfunctions.net";

  // ì¹´ë“œ ì´ë¯¸ì§€ ë§µ (UI í‘œì‹œìš©ë§Œ â€” ë¡œì§ ì—†ìŒ)
  const cardMap = Object.fromEntries(
    Array.from({length: 78}, (_, i) => [`card_${i}`, `https://kang-sd.github.io/taro_images/card_${i}.webp`])
  );
  cardMap.back = "https://kang-sd.github.io/taro_images/card_back.webp";

  let picks  = [null, null];
  let adminPw = null; // ê´€ë¦¬ì ì„¸ì…˜ ì¤‘ ì¬ì‚¬ìš©

  // â”€â”€ ê³µí†µ fetch ë˜í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function api(endpoint, body) {
    const res = await fetch(`${FN}/${endpoint}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "ì„œë²„ ì˜¤ë¥˜");
    return data;
  }

  // â”€â”€ 1ë‹¨ê³„: ì œí•œ í™•ì¸ í›„ 2ë‹¨ê³„ ì´ë™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function checkLimitAndGo() {
    const name  = document.getElementById('uName').value.trim();
    const topic = document.getElementById('uTopic').value;
    const quest = document.getElementById('uQuest').value.trim();
    if (!name)  { alert("ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    if (!topic) { alert("ìƒë‹´ ì£¼ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
    if (!quest) { alert("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

    const btn = document.getElementById('startBtn');
    btn.disabled = true; btn.textContent = "í™•ì¸ ì¤‘...";
    try {
      const { over } = await api("checkLimit", { name });
      if (over) { alert("ì˜¤ëŠ˜ì˜ ìƒë‹´ íšŸìˆ˜(2íšŒ)ë¥¼ ì´ˆê³¼í•˜ì˜€ìŠµë‹ˆë‹¤.\në‚´ì¼ ë‹¤ì‹œ ë°©ë¬¸í•´ì£¼ì„¸ìš”!"); return; }
      document.getElementById('p1').classList.remove('active');
      document.getElementById('p2').classList.add('active');
    } catch(e) {
      alert("ì˜¤ë¥˜: " + e.message);
    } finally {
      btn.disabled = false; btn.textContent = "ì…”í”Œ ì‹œì‘í•˜ê¸°";
    }
  }

  // â”€â”€ ì¹´ë“œ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flip(n) {
    if (picks[n-1]) return;
    if (n === 2 && !picks[0]) { alert("ì²« ë²ˆì§¸ ì¹´ë“œë¥¼ ë¨¼ì € ê³ ë¥´ì„¸ìš”."); return; }
    const r = Math.floor(Math.random() * 78);
    picks[n-1] = `card_${r}`;
    const slot = document.getElementById(`slot${n}`);
    slot.style.backgroundImage = `url('${cardMap[picks[n-1]]}')`;
    slot.classList.add('flipped');
    if (n === 1) {
      document.getElementById('guide').innerText = "ë‘ ë²ˆì§¸ ì¹´ë“œë¥¼ ê³ ë¥´ì„¸ìš”";
    } else {
      document.getElementById('guide').style.display = 'none';
      document.getElementById('resBtn').style.display = 'block';
    }
  }

  // â”€â”€ 2ë‹¨ê³„ â†’ 3ë‹¨ê³„: ì €ì¥ + í•´ì„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function go3() {
    document.getElementById('p2').classList.remove('active');
    document.getElementById('p3').classList.add('active');
    document.getElementById('finalOutput').innerHTML =
      "<p style='padding:50px; color:#999;'>ìš´ëª…ì˜ ë©”ì‹œì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>";

    const name  = document.getElementById('uName').value;
    const topic = document.getElementById('uTopic').value;
    const quest = document.getElementById('uQuest').value;
    try {
      const [_, d1, d2] = await Promise.all([
        api("saveLog",     { user: name, topic, quest, cards: picks }),
        api("getCardData", { cardId: picks[0], topic, type: "ê³¼ì •" }),
        api("getCardData", { cardId: picks[1], topic, type: "ê²°ê³¼" })
      ]);
      document.getElementById('finalOutput').innerHTML = generateResultHTML(name, picks, [d1, d2]);
    } catch(e) {
      document.getElementById('finalOutput').innerHTML =
        `<p style='color:#ff5a5a; padding:20px;'>ì˜¤ë¥˜: ${e.message}</p>`;
    }
  }

  // â”€â”€ ê²°ê³¼ HTML ìƒì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function generateResultHTML(userName, cards, cardData) {
    let html = `<h3 style="color:var(--gold); margin-bottom:25px;">${userName}ë‹˜ì˜ ìš´ëª… ê²°ê³¼</h3>`;
    cardData.forEach((d, i) => {
      const label = i === 0 ? '[ê³¼ì •ì˜ íë¦„]' : '[ìµœì¢… ê²°ê³¼]';
      html += `
        <div class="res-card">
          <img src="${cardMap[cards[i]]}" class="res-img" alt="${d.name}">
          <b style="color:var(--gold); font-size:1.1rem;">${label} ${d.name}</b>
          <div class="d-label">í•µì‹¬ í‚¤ì›Œë“œ</div>
          <div class="d-content">${d.key}</div>
          <div class="d-label">ì¹´ë“œì˜ ì„œì‚¬</div>
          <div class="d-content">${d.story}</div>
          <div class="d-label">ìš´ëª…ì˜ í•´ì„</div>
          <div class="d-content" style="font-weight:bold; font-size:1rem;">${d.txt}</div>
          <div class="d-label">ê¸ì • / ë¶€ì •</div>
          <div class="d-content">ê¸ì • ${d.pos} / ë¶€ì • ${d.neg}</div>
          <div class="d-label">ê°ì • í†¤</div>
          <div class="d-content">${d.tone}</div>
          <div class="d-label">ê°ì • ì„¤ëª…</div>
          <div class="d-content">${d.desc}</div>
          <div class="d-label">ì¡°ì–¸</div>
          <div class="d-content">
            <b style="color:#28a745;">(+) ê¸ì •ì  ì¸¡ë©´</b><br>${d.posA}
            <br><br>
            <b style="color:#dc3545;">(-) ì£¼ì˜í•  ì </b><br>${d.negA}
          </div>
        </div>`;
    });
    return html;
  }

  // â”€â”€ ê´€ë¦¬ì: ê¸°ë¡ ëª©ë¡ ì¡°íšŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openAdmin() {
    const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸");
    if (!pw) return;
    document.getElementById('adminModal').style.display = 'block';
    document.getElementById('adminList').innerHTML = "<p style='text-align:center;color:#999;padding:20px;'>ë¡œë”© ì¤‘...</p>";
    try {
      const { logs } = await api("adminGetLogs", { password: pw });
      adminPw = pw;
      let html = "";
      logs.forEach(d => {
        html += `
          <div class="admin-record">
            <b style="font-size:1.1rem;">${d.user}</b> <small>[${d.topic}]</small><br>
            <span style="color:#555;">ì§ˆë¬¸: ${d.quest}</span><br>
            <small style="color:#999;">${d.timeStr}</small>
            <div style="margin-top:10px;">
              <button onclick='viewResult(${JSON.stringify(d)})' class="admin-btn btn-view">ğŸ“„ ê²°ê³¼ë³´ê¸°</button>
              <button onclick="delLog('${d.id}')" class="admin-btn btn-delete">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>
          </div>`;
      });
      document.getElementById('adminList').innerHTML =
        html || "<p style='text-align:center;color:#999;padding:20px;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    } catch(e) {
      document.getElementById('adminList').innerHTML =
        `<p style='color:#ff5a5a;padding:20px;'>${e.message === "ì¸ì¦ ì‹¤íŒ¨" ? "âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤." : "ì˜¤ë¥˜: " + e.message}</p>`;
    }
  }

  function closeAdmin() { document.getElementById('adminModal').style.display = 'none'; }

  // â”€â”€ ê´€ë¦¬ì: ê²°ê³¼ ë³´ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function viewResult(data) {
    document.getElementById('resultModal').style.display = 'block';
    document.getElementById('modalResultContent').innerHTML = "<p style='padding:50px;text-align:center;'>ë¡œë”© ì¤‘...</p>";
    try {
      const { user, topic, quest, cards } = data;
      if (!cards || cards.length < 2) throw new Error("ì¹´ë“œ ì •ë³´ ì—†ìŒ");
      const [d1, d2] = await Promise.all([
        api("getCardData", { cardId: cards[0], topic, type: "ê³¼ì •" }),
        api("getCardData", { cardId: cards[1], topic, type: "ê²°ê³¼" })
      ]);
      let html = `
        <div style="text-align:center;margin-bottom:20px;padding-bottom:20px;border-bottom:2px solid #f1f1f1;">
          <h3 style="color:var(--gold);margin:0;">${user}ë‹˜ì˜ íƒ€ë¡œ ê²°ê³¼</h3>
          <small style="color:#999;">${topic} | ${quest}</small>
        </div>`;
      html += generateResultHTML(user, cards, [d1, d2]);
      document.getElementById('modalResultContent').innerHTML = html;
    } catch(e) {
      document.getElementById('modalResultContent').innerHTML =
        `<p style='color:#ff5a5a;padding:20px;'>ì˜¤ë¥˜: ${e.message}</p>`;
    }
  }

  function closeResult(event) {
    if (!event || event.target.id === 'resultModal')
      document.getElementById('resultModal').style.display = 'none';
  }

  // â”€â”€ ê´€ë¦¬ì: ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function delLog(id) {
    if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    try {
      await api("adminDeleteLog", { password: adminPw, id });
      alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      openAdmin();
    } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
  }
</script>

</body>
</html>




<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë§ˆìŒì˜ íë¦„, íƒ€ë¡œ</title>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBf9M6rinPb9Ib9JMK18g4TsMIVqy9Umqo",
      authDomain: "taro-project-624a3.firebaseapp.com",
      projectId: "taro-project-624a3",
      storageBucket: "taro-project-624a3.firebasestorage.app",
      messagingSenderId: "1042873680198",
      appId: "1:1042873680198:web:e0a760805573b24c3ca547",
      measurementId: "G-9T3WJCSJM6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ğŸ”´ Firebase ë°ì´í„° ì¡°íšŒ (ë„ì–´ì“°ê¸° í•„ë“œëª… ì™„ë²½ ëŒ€ì‘)
    async function getInterpretation(c1Id, c2Id, topic) {
      try {
        const cleanTopic = topic.replace(/\//g, ""); 
        const refs = [
          doc(db, "interpretations", `${c1Id}_${cleanTopic}_ê³¼ì •`),
          doc(db, "interpretations", `${c2Id}_${cleanTopic}_ê²°ê³¼`),
          doc(db, "card_details", c1Id),
          doc(db, "card_details", c2Id)
        ];
        const snaps = await Promise.all(refs.map(r => getDoc(r)));
        
        const format = (snapI, snapD) => ({
          cardName: snapD.exists() ? snapD.data()["ì¹´ë“œëª…"] : "ì•Œ ìˆ˜ ì—†ìŒ",
          interpretation: snapI.exists() ? snapI.data()["í•´ì„ë¬¸ì¥"] : "",
          positive: snapI.exists() ? snapI.data()["ê¸ì •"] : "0",
          negative: snapI.exists() ? snapI.data()["ë¶€ì •"] : "0",
          tone: snapI.exists() ? snapI.data()["ê°ì •í†¤"] : "",
          description: snapI.exists() ? snapI.data()["ê°ì •ì„¤ëª…"] : "",
          keywords: snapD.exists() ? snapD.data()["ì£¼ìš” í‚¤ì›Œë“œ"] : "ë‚´ìš© ì—†ìŒ", // ê³µë°± ë°˜ì˜
          story: snapD.exists() ? snapD.data()["ì¹´ë“œ ì„œì‚¬"] : "ë‚´ìš© ì—†ìŒ",     // ê³µë°± ë°˜ì˜
          positiveAspect: snapD.exists() ? snapD.data()["ê¸ì •ì  ì¸¡ë©´"] : "ë‚´ìš© ì—†ìŒ", // ê³µë°± ë°˜ì˜
          negativeAspect: snapD.exists() ? snapD.data()["ë¶€ì •ì  ì¸¡ë©´"] : "ë‚´ìš© ì—†ìŒ"  // ê³µë°± ë°˜ì˜
        });

        return { card1: format(snaps[0], snaps[2]), card2: format(snaps[1], snaps[3]) };
      } catch (e) { return null; }
    }
    window.getInterpretation = getInterpretation;
    window.cardImageMap = Array.from({length: 78}, (_, i) => `https://kang-sd.github.io/taro_images/card_${i}.webp`)
      .reduce((a, c, i) => ({...a, [`card_${i}`]: c}), {card_back: "https://kang-sd.github.io/taro_images/card_back.webp"});
  </script>

  <style>
    /* ğŸ”´ ë‹¹ì´ˆ CSS ìŠ¤íƒ€ì¼ ìœ ì§€ */
    body { background: #1e1b2e; color: #f2f2f2; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 1rem; }
    .container { width: 95vw; max-width: 800px; margin: auto; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(8px); border-radius: 12px; padding: 2rem; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.6s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    /* ğŸ”´ ì²« í™”ë©´ 0ë²ˆ ì¹´ë“œ ë°°ì¹˜ */
    .main-card-img { width: 160px; border-radius: 12px; margin: 20px auto; box-shadow: 0 0 25px rgba(108, 92, 231, 0.4); border: 1px solid rgba(255,255,255,0.1); }
    
    .title { font-size: 1.6rem; color: #dcd0ff; margin-bottom: 1.5rem; font-weight: bold; }
    .intro-text { line-height: 1.7; background: rgba(0,0,0,0.25); padding: 1.5rem; border-radius: 10px; font-size: 0.95rem; text-align: left; color: #ccc; margin-bottom: 2rem; }
    .form-group { text-align: left; margin-bottom: 1.2rem; }
    .form-group label { display: block; color: #bca0ff; font-weight: bold; margin-bottom: 0.5rem; }
    input, select, textarea { width: 100%; padding: 0.9rem; border-radius: 8px; background: #2a2640; color: #fff; border: 1px solid #444; font-size: 1rem; box-sizing: border-box; }
    
    /* ğŸ”´ í™”ë©´ 2: ì¹´ë“œ ì„ê¸° & ì„ íƒ */
    .card-slots { display: flex; justify-content: center; gap: 20px; margin: 30px 0; min-height: 260px; }
    .card-slot { width: 140px; height: 240px; perspective: 1000px; cursor: pointer; }
    .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.8s; transform-style: preserve-3d; }
    .card-inner.is-flipped { transform: rotateY(180deg); }
    .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 10px; }
    .card-front { transform: rotateY(180deg); }
    .card-back { background: url('https://kang-sd.github.io/taro_images/card_back.webp') no-repeat center/cover; border: 1px solid rgba(255,255,255,0.1); }
    
    .btn { width: 100%; padding: 1.2rem; background: #6c5ce7; color: white; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 15px; }
    .btn:hover { background: #5849c4; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); }

    /* ğŸ”´ í™”ë©´ 3: ê²°ê³¼ ìƒì„¸ ë°•ìŠ¤ */
    .card-detail-box { background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem; border-left: 5px solid #6c5ce7; text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .badge { display: inline-block; background: #6c5ce7; color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; margin-bottom: 15px; }
    .card-title-text { font-size: 1.4rem; font-weight: bold; color: #dcd0ff; margin-bottom: 10px; }
    .detail-label { font-size: 0.85rem; color: #a389ad; margin-top: 15px; border-bottom: 1px solid #333; font-weight: bold; padding-bottom: 3px; }
    .detail-content { color: #eee; margin-top: 5px; line-height: 1.6; font-size: 1rem; }
  </style>
</head>
<body>

<div class="container">
  <div id="p1" class="page active">
    <div class="title">ì§€ê¸ˆ ë‚´ ê°ì •ì€ ì–´ë””ë¡œ íë¥¼ê¹Œ?</div>
    <img src="https://kang-sd.github.io/taro_images/card_0.webp" class="main-card-img" alt="The Fool">
    
    <div class="intro-text">
      <strong>íƒ€ë¡œë€?</strong> ìƒì§•ì˜ ì¹´ë“œë¡œ ë‚´ë©´ì˜ ê°ì • íë¦„ì„ ë¹„ì¶”ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.<br>
      ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ì§ˆë¬¸ì´ íƒ€ë¡œ ì§„í–‰ì˜ ì •í™•ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.<br>
      ë‹¹ì‹ ì˜ ë§ˆìŒì´ ê°„ì ˆí•  ë•Œ ì¹´ë“œëŠ” ë°©í–¥ì„ ì œì‹œí•©ë‹ˆë‹¤.<br>
      í•˜ë£¨ 2ë²ˆ ì°¸ì—¬ ê°€ëŠ¥í•˜ë©°, ê¸°ë¡ì€ 3ì¼ê°„ ìœ ì§€ë©ë‹ˆë‹¤.
    </div>
    
    <div class="form-group"><label>ë‹¹ì‹ ì˜ ì´ë¦„</label><input type="text" id="userName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"></div>
    <div class="form-group">
      <label>ìƒë‹´ ì£¼ì œ</label>
      <select id="topic">
        <option>ì—°ì• </option><option>ì§„ë¡œì§ì—…</option><option>ê¸ˆì „</option><option>ê°ì •</option><option>ê±´ê°•</option><option>ì‹œí—˜í•©ê²©ìš´</option>
      </select>
    </div>
    <div class="form-group"><label>êµ¬ì²´ì ì¸ ì§ˆë¬¸</label><textarea id="question" rows="2" placeholder="ê³ ë¯¼ì„ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”"></textarea></div>
    <button class="btn" onclick="toStep2()">ìš´ëª…ì˜ ì¹´ë“œ ì„ê¸°</button>
  </div>

  <div id="p2" class="page">
    <div class="title" id="p2Title">ì¹´ë“œë¥¼ ì„ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    <div class="card-slots" id="deck">
      <div class="card-slot" onclick="doFlip(1)"><div id="i1" class="card-inner"><div class="card-back"></div><img id="f1" class="card-front"></div></div>
      <div class="card-slot" onclick="doFlip(2)"><div id="i2" class="card-inner"><div class="card-back"></div><img id="f2" class="card-front"></div></div>
    </div>
    <div id="guide" style="color:#aaa; font-style:italic; margin-bottom:10px;">ì²« ë²ˆì§¸ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
    <button class="btn" id="goResBtn" style="display:none;" onclick="toStep3()">í•´ì„ ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
  </div>

  <div id="p3" class="page">
    <div class="title">ë‹¹ì‹ ì„ ìœ„í•œ íƒ€ë¡œ ë©”ì‹œì§€</div>
    <div id="finalOutput"></div>
    <button class="btn" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>
</div>

<script>
  let myPicks = [null, null];

  function toStep2() {
    if(!document.getElementById('userName').value) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
    document.getElementById('p1').classList.remove('active');
    document.getElementById('p2').classList.add('active');
    // ì…”í”Œ ì• ë‹ˆë©”ì´ì…˜ ëŠë‚Œì„ ìœ„í•œ ë”œë ˆì´
    setTimeout(() => { document.getElementById('p2Title').innerText = "ë‘ ì¥ì˜ ì¹´ë“œë¥¼ ì •ì„±ê» ê³ ë¥´ì„¸ìš”"; }, 1500);
  }

  function doFlip(n) {
    if (myPicks[n-1]) return;
    if (n === 2 && !myPicks[0]) { alert("ì²« ë²ˆì§¸ ì¹´ë“œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }
    
    const randomNum = Math.floor(Math.random() * 78);
    const cardId = `card_${randomNum}`;
    myPicks[n-1] = cardId;
    
    document.getElementById(`f${n}`).src = window.cardImageMap[cardId];
    document.getElementById(`i${n}`).classList.add('is-flipped');
    
    if (n === 1) document.getElementById('guide').innerText = "ë‘ ë²ˆì§¸ ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.";
    else { 
      document.getElementById('guide').style.display = 'none'; 
      document.getElementById('goResBtn').style.display = 'block'; 
    }
  }

  async function toStep3() {
    const topic = document.getElementById('topic').value;
    document.getElementById('p2').classList.remove('active');
    document.getElementById('p3').classList.add('active');
    document.getElementById('finalOutput').innerHTML = "<div style='padding:40px;'>ì‹ ë¹„ë¡œìš´ ê¸°ìš´ì„ ë‹´ì•„ í•´ì„ ì¤‘ì…ë‹ˆë‹¤...</div>";
    
    const data = await window.getInterpretation(myPicks[0], myPicks[1], topic);
    
    if(data) {
      let resultHtml = "";
      [data.card1, data.card2].forEach((c, idx) => {
        resultHtml += `
        <div class="card-detail-box">
          <div class="badge">${idx==0 ? 'ê³¼ì •ì˜ íë¦„' : 'ìµœì¢… ê²°ê³¼ ë° ì¡°ì–¸'}</div>
          <div class="card-title-text">${c.cardName}</div>
          <div class="detail-label">ì£¼ìš” í‚¤ì›Œë“œ</div><div class="detail-content">${c.keywords}</div>
          <div class="detail-label">ì¹´ë“œ ì„œì‚¬</div><div class="detail-content">${c.story}</div>
          <div class="detail-label">íƒ€ë¡œ í•´ì„</div><div class="detail-content" style="color:#fff; font-weight:bold; font-size:1.1rem;">${c.interpretation}</div>
          <div class="detail-label">ê¸ì •/ë¶€ì • ìˆ˜ì¹˜</div><div class="detail-content">ê¸ì • ${c.positive}% / ë¶€ì • ${c.negative}%</div>
          <div class="detail-label">ê°ì •í†¤ / ì„¤ëª…</div><div class="detail-content">${c.tone} - ${c.description}</div>
          <div class="detail-label">ê¸ì •ì  ì¸¡ë©´</div><div class="detail-content">${c.positiveAspect}</div>
          <div class="detail-label">ë¶€ì •ì  ì¸¡ë©´</div><div class="detail-content">${c.negativeAspect}</div>
        </div>`;
      });
      document.getElementById('finalOutput').innerHTML = resultHtml;
    }
  }
</script>
</body>
</html>
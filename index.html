

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jennifer Canvas | AI 타로</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400;1,600&family=Noto+Serif+KR:wght@300;400&display=swap" rel="stylesheet">

  <style>
    /* ══════════════════════════════════════
       TOKENS
    ══════════════════════════════════════ */
    :root {
      --void:    #050507;
      --deep:    #0a0a10;
      --chamber: #0e0e18;
      --veil:    #14141f;
      --gold:    #c8a96e;
      --gold2:   #e8c98a;
      --gold3:   #f5dfa0;
      --silver:  #8a8aa8;
      --mist:    rgba(200,169,110,0.08);
      --border:  rgba(200,169,110,0.18);
      --text:    #d4cfc8;
      --faint:   #5a5a72;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { scroll-behavior: smooth; }

    body {
      background: var(--void);
      color: var(--text);
      font-family: 'Noto Serif KR', serif;
      font-weight: 300;
      min-height: 100vh;
      overflow-x: hidden;
      cursor: default;
    }

    /* ── 별빛 캔버스 ── */
    #starfield {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    /* ── 배경 오브 ── */
    .orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(120px);
      pointer-events: none;
      z-index: 0;
      opacity: 0.18;
    }
    .orb-1 { width: 600px; height: 600px; top: -200px; left: -200px; background: radial-gradient(circle, #2a1a5e, transparent); }
    .orb-2 { width: 500px; height: 500px; bottom: -150px; right: -150px; background: radial-gradient(circle, #1a0a3e, transparent); }
    .orb-3 { width: 300px; height: 300px; top: 40%; left: 50%; transform: translate(-50%,-50%); background: radial-gradient(circle, #c8a96e22, transparent); animation: orbPulse 6s ease-in-out infinite; }

    @keyframes orbPulse {
      0%, 100% { opacity: 0.12; transform: translate(-50%,-50%) scale(1); }
      50%       { opacity: 0.22; transform: translate(-50%,-50%) scale(1.15); }
    }

    /* ── 메인 패널 ── */
    .panel {
      position: relative;
      z-index: 1;
      width: 92vw;
      max-width: 560px;
      margin: 40px auto 60px;
      background: linear-gradient(160deg, #10101a 0%, #0c0c16 100%);
      border: 1px solid var(--border);
      border-radius: 2px;
      box-shadow:
        0 0 0 1px rgba(200,169,110,0.06),
        0 40px 120px rgba(0,0,0,0.8),
        inset 0 1px 0 rgba(200,169,110,0.12);
    }

    /* ── 상단 장식선 ── */
    .panel-crown {
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold2), var(--gold), var(--gold2), transparent);
    }

    /* ── 헤더 ── */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 28px 32px 24px;
      border-bottom: 1px solid var(--border);
    }

    .header-symbol {
      font-size: 1.3rem;
      opacity: 0.5;
      letter-spacing: 3px;
      color: var(--gold);
    }

    .header-brand {
      text-align: center;
    }

    .brand-main {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-weight: 300;
      font-style: italic;
      letter-spacing: 6px;
      color: var(--gold2);
      text-transform: uppercase;
      line-height: 1;
    }

    .brand-sub {
      font-size: 0.6rem;
      letter-spacing: 5px;
      color: var(--faint);
      text-transform: uppercase;
      margin-top: 4px;
    }

    .header-gear {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 50%;
      cursor: pointer;
      color: var(--faint);
      font-size: 0.85rem;
      transition: all 0.3s;
    }

    .header-gear:hover {
      border-color: var(--gold);
      color: var(--gold);
      background: var(--mist);
    }

    /* ── 바디 ── */
    .body { padding: 36px 32px; }

    /* ── 페이지 전환 ── */
    .page { display: none; }
    .page.active { display: block; animation: revealUp 0.6s cubic-bezier(0.16,1,0.3,1) both; }

    @keyframes revealUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ── 인트로 블록 ── */
    .intro-block {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      padding: 22px;
      background: var(--mist);
      border: 1px solid var(--border);
      border-radius: 1px;
      margin-bottom: 28px;
      position: relative;
      overflow: hidden;
    }

    .intro-block::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 2px; height: 100%;
      background: linear-gradient(180deg, transparent, var(--gold), transparent);
    }

    .intro-card-img {
      width: 80px;
      flex-shrink: 0;
      border-radius: 1px;
      filter: sepia(20%) brightness(0.9);
      box-shadow: 0 8px 24px rgba(0,0,0,0.5), 0 0 0 1px rgba(200,169,110,0.2);
    }

    .intro-text {
      font-size: 0.82rem;
      line-height: 1.75;
      color: #9898b8;
    }

    .hl-gold { color: var(--gold2); font-weight: 400; }
    .hl-light { color: #b8b8d8; font-weight: 400; }

    /* ── 구분선 ── */
    .divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 24px 0;
      color: var(--faint);
      font-size: 0.65rem;
      letter-spacing: 4px;
      text-transform: uppercase;
    }
    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--border));
    }
    .divider::after { background: linear-gradient(90deg, var(--border), transparent); }

    /* ── 입력 필드 ── */
    .field-group { margin-bottom: 16px; }

    .field-label {
      font-size: 0.62rem;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--faint);
      margin-bottom: 8px;
      display: block;
    }

    input, select, textarea {
      width: 100%;
      padding: 14px 18px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(200,169,110,0.15);
      border-radius: 1px;
      color: var(--text);
      font-family: 'Noto Serif KR', serif;
      font-size: 0.9rem;
      font-weight: 300;
      transition: all 0.3s;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    input::placeholder, textarea::placeholder { color: var(--faint); font-style: italic; }
    select option { background: #0e0e18; color: var(--text); }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(200,169,110,0.5);
      background: rgba(200,169,110,0.04);
      box-shadow: 0 0 0 3px rgba(200,169,110,0.06), 0 0 20px rgba(200,169,110,0.04);
    }

    textarea { resize: none; line-height: 1.6; }

    /* select 화살표 커스텀 */
    .select-wrap { position: relative; }
    .select-wrap::after {
      content: '▾';
      position: absolute;
      right: 18px; top: 50%;
      transform: translateY(-50%);
      color: var(--gold);
      font-size: 0.7rem;
      pointer-events: none;
    }

    /* ── 주 버튼 ── */
    .btn-primary {
      width: 100%;
      padding: 18px;
      background: transparent;
      border: 1px solid var(--gold);
      color: var(--gold2);
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 400;
      font-style: italic;
      letter-spacing: 4px;
      cursor: pointer;
      transition: all 0.4s;
      border-radius: 1px;
      position: relative;
      overflow: hidden;
      margin-top: 8px;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(200,169,110,0.1), rgba(200,169,110,0.02));
      opacity: 0;
      transition: opacity 0.4s;
    }

    .btn-primary:hover {
      border-color: var(--gold2);
      color: var(--gold3);
      box-shadow: 0 0 30px rgba(200,169,110,0.15), inset 0 0 30px rgba(200,169,110,0.05);
      letter-spacing: 6px;
    }

    .btn-primary:hover::before { opacity: 1; }
    .btn-primary:disabled { opacity: 0.35; cursor: not-allowed; letter-spacing: 4px; box-shadow: none; }

    /* ── 보조 버튼 ── */
    .btn-ghost {
      width: 100%;
      padding: 14px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--silver);
      font-family: 'Noto Serif KR', serif;
      font-size: 0.85rem;
      font-weight: 300;
      cursor: pointer;
      transition: all 0.3s;
      border-radius: 1px;
      margin-top: 8px;
    }

    .btn-ghost:hover { border-color: rgba(255,255,255,0.2); color: var(--text); }

    /* ── 카드 선택 스테이지 ── */
    .stage-title {
      text-align: center;
      margin-bottom: 36px;
    }

    .stage-title h2 {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.6rem;
      font-weight: 300;
      font-style: italic;
      color: var(--gold2);
      letter-spacing: 2px;
      line-height: 1.3;
    }

    .stage-title p {
      font-size: 0.72rem;
      letter-spacing: 3px;
      color: var(--faint);
      margin-top: 8px;
      text-transform: uppercase;
    }

    /* ── 카드 슬롯 ── */
    .card-arena {
      display: flex;
      justify-content: center;
      gap: 28px;
      margin: 0 0 32px;
      perspective: 1000px;
    }

    .card-wrap { position: relative; }

    .card-number {
      text-align: center;
      font-size: 0.6rem;
      letter-spacing: 3px;
      color: var(--faint);
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .card-box {
      width: 120px;
      height: 210px;
      border-radius: 1px;
      cursor: pointer;
      background-image: url('https://kang-sd.github.io/taro_images/card_back.webp');
      background-size: cover;
      background-position: center;
      border: 1px solid rgba(200,169,110,0.2);
      box-shadow:
        0 20px 60px rgba(0,0,0,0.6),
        0 0 0 1px rgba(200,169,110,0.05);
      transition: all 0.5s cubic-bezier(0.34,1.56,0.64,1);
      transform-style: preserve-3d;
      position: relative;
    }

    .card-box::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(160deg, rgba(255,255,255,0.04) 0%, transparent 60%);
      border-radius: 1px;
      pointer-events: none;
    }

    .card-box:not(.locked):hover {
      transform: translateY(-8px) rotateY(-5deg);
      box-shadow:
        0 30px 80px rgba(0,0,0,0.7),
        0 0 40px rgba(200,169,110,0.12),
        0 0 0 1px rgba(200,169,110,0.3);
    }

    .card-box.locked { cursor: default; }

    .card-box.flipped {
      border-color: rgba(200,169,110,0.5);
      box-shadow:
        0 20px 60px rgba(0,0,0,0.6),
        0 0 40px rgba(200,169,110,0.2),
        0 0 80px rgba(200,169,110,0.08);
      animation: cardReveal 0.6s cubic-bezier(0.34,1.56,0.64,1);
    }

    @keyframes cardReveal {
      0%   { transform: rotateY(-90deg) scale(0.8); }
      60%  { transform: rotateY(8deg) scale(1.05); }
      100% { transform: rotateY(0deg) scale(1); }
    }

    .card-label {
      text-align: center;
      margin-top: 10px;
      font-size: 0.68rem;
      letter-spacing: 1px;
      color: var(--faint);
      font-style: italic;
      min-height: 16px;
    }

    .card-label.chosen { color: var(--gold); }

    /* ── 가이드 텍스트 ── */
    .guide-text {
      text-align: center;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1rem;
      font-style: italic;
      color: var(--silver);
      letter-spacing: 2px;
      margin-bottom: 24px;
      min-height: 24px;
    }

    .guide-text.ready { color: var(--gold2); }

    /* ── 로딩 ── */
    .reading-loader {
      text-align: center;
      padding: 60px 0;
    }

    .loader-sigil {
      width: 60px;
      height: 60px;
      margin: 0 auto 24px;
      position: relative;
    }

    .loader-sigil::before, .loader-sigil::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      border: 1px solid var(--gold);
    }

    .loader-sigil::before {
      inset: 0;
      animation: sigilSpin 2s linear infinite;
      border-color: var(--gold) transparent transparent transparent;
    }

    .loader-sigil::after {
      inset: 8px;
      animation: sigilSpin 1.5s linear infinite reverse;
      border-color: transparent var(--gold2) transparent transparent;
    }

    @keyframes sigilSpin { to { transform: rotate(360deg); } }

    .loader-text {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1rem;
      font-style: italic;
      color: var(--silver);
      letter-spacing: 3px;
    }

    /* ── 결과 카드 ── */
    .res-card {
      border: 1px solid var(--border);
      border-radius: 1px;
      padding: 28px;
      margin-bottom: 20px;
      background: linear-gradient(160deg, rgba(200,169,110,0.04) 0%, rgba(255,255,255,0.01) 100%);
      position: relative;
      overflow: hidden;
    }

    .res-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 2px; height: 100%;
      background: linear-gradient(180deg, var(--gold) 0%, transparent 100%);
    }

    .res-card-top {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .res-img {
      width: 78px;
      flex-shrink: 0;
      border-radius: 1px;
      filter: sepia(10%) brightness(0.95);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 1px rgba(200,169,110,0.2);
    }

    .res-card-meta {}

    .res-position {
      font-size: 0.6rem;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--faint);
      margin-bottom: 6px;
    }

    .res-name {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.4rem;
      font-weight: 300;
      font-style: italic;
      color: var(--gold2);
      line-height: 1.2;
    }

    .res-key {
      font-size: 0.78rem;
      color: var(--silver);
      margin-top: 6px;
      letter-spacing: 1px;
    }

    .res-section { margin-top: 16px; }

    .res-section-label {
      font-size: 0.6rem;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(200,169,110,0.15);
    }

    .res-section-body {
      font-size: 0.88rem;
      line-height: 1.8;
      color: #aaaac0;
    }

    .res-section-body.emphasis {
      color: var(--text);
      font-size: 0.9rem;
    }

    .advice-pos { color: #6ec68a; font-size: 0.8rem; }
    .advice-neg { color: #e0786a; font-size: 0.8rem; }

    .tone-pill {
      display: inline-block;
      padding: 4px 12px;
      border: 1px solid rgba(200,169,110,0.3);
      border-radius: 100px;
      font-size: 0.72rem;
      color: var(--gold);
      letter-spacing: 1px;
    }

    .score-row {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 0.82rem;
      margin-top: 4px;
    }

    .score-bar-wrap {
      flex: 1;
      height: 2px;
      background: rgba(255,255,255,0.06);
      border-radius: 1px;
      overflow: hidden;
    }

    .score-bar {
      height: 100%;
      border-radius: 1px;
      background: linear-gradient(90deg, var(--gold), var(--gold2));
    }

    .score-bar.neg { background: linear-gradient(90deg, #8a3530, #c0504a); }

    .score-pct { font-size: 0.72rem; color: var(--faint); width: 36px; text-align: right; }

    /* ── 결과 헤더 ── */
    .result-header {
      text-align: center;
      padding: 0 0 32px;
      margin-bottom: 32px;
      border-bottom: 1px solid var(--border);
    }

    .result-header-eyebrow {
      font-size: 0.6rem;
      letter-spacing: 5px;
      text-transform: uppercase;
      color: var(--faint);
      margin-bottom: 12px;
    }

    .result-header-name {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 300;
      font-style: italic;
      color: var(--gold2);
      letter-spacing: 2px;
    }

    .result-header-name span {
      color: var(--text);
      font-style: normal;
      font-size: 1rem;
      letter-spacing: 3px;
      margin-left: 6px;
      vertical-align: middle;
    }

    /* ── 푸터 버튼 ── */
    .result-actions { margin-top: 8px; display: flex; flex-direction: column; gap: 8px; }

    /* ── 하단 크레딧 ── */
    .panel-foot {
      border-top: 1px solid var(--border);
      padding: 16px 32px;
      text-align: center;
    }

    .panel-foot-text {
      font-size: 0.6rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--faint);
    }

    /* ══════════════════════════════════════
       관리자 모달
    ══════════════════════════════════════ */
    #adminModal {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--void);
      z-index: 9999;
      overflow-y: auto;
      padding: 40px 24px;
    }

    .admin-inner {
      max-width: 680px;
      margin: 0 auto;
    }

    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .admin-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-style: italic;
      color: var(--gold2);
      letter-spacing: 2px;
    }

    .admin-close-btn {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--silver);
      font-family: 'Noto Serif KR', serif;
      font-size: 0.82rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .admin-close-btn:hover { border-color: var(--gold); color: var(--gold); }

    .admin-record {
      padding: 20px;
      border: 1px solid var(--border);
      margin-bottom: 10px;
      background: var(--mist);
      position: relative;
    }

    .admin-record::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 2px; height: 100%;
      background: var(--gold);
      opacity: 0.4;
    }

    .admin-record-name { color: var(--gold2); font-size: 1rem; margin-bottom: 4px; }
    .admin-record-info { font-size: 0.82rem; color: var(--silver); margin-bottom: 4px; }
    .admin-record-time { font-size: 0.72rem; color: var(--faint); margin-bottom: 12px; }

    .admin-btn {
      padding: 8px 16px;
      border: 1px solid;
      border-radius: 1px;
      cursor: pointer;
      font-size: 0.78rem;
      font-family: 'Noto Serif KR', serif;
      font-weight: 300;
      margin-right: 8px;
      transition: all 0.25s;
      background: transparent;
    }

    .btn-view   { border-color: rgba(100,160,220,0.5); color: #80b0e0; }
    .btn-view:hover   { background: rgba(100,160,220,0.1); border-color: #80b0e0; }
    .btn-delete { border-color: rgba(220,100,100,0.5); color: #e08080; }
    .btn-delete:hover { background: rgba(220,100,100,0.1); border-color: #e08080; }

    /* ══════════════════════════════════════
       결과 모달
    ══════════════════════════════════════ */
    #resultModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(8px);
      z-index: 10000;
      overflow-y: auto;
      padding: 40px 20px;
    }

    #resultModalContent {
      background: #0c0c16;
      border: 1px solid var(--border);
      max-width: 580px;
      margin: 0 auto;
      border-radius: 1px;
      padding: 36px;
      position: relative;
    }

    .modal-close-btn {
      position: absolute;
      top: 16px; right: 16px;
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--faint);
      cursor: pointer;
      border-radius: 50%;
      font-size: 1rem;
      transition: all 0.3s;
    }

    .modal-close-btn:hover { border-color: var(--gold); color: var(--gold); }

    /* ══════════════════════════════════════
       인쇄
    ══════════════════════════════════════ */
    @media print {
      body { background: white; color: #222; }
      .orb, #starfield { display: none; }
      .panel { box-shadow: none; border: none; max-width: 100%; background: white; }
      .header, .btn-primary, .btn-ghost, .result-actions { display: none !important; }
      .res-card { border: 1px solid #ddd; background: white; }
      .res-card::before { display: none; }
      .res-name, .result-header-name { color: #8a6028; }
      .res-section-label { color: #8a6028; border-color: #ddd; }
      .res-section-body, .res-section-body.emphasis { color: #333; }
      .panel-crown, .panel-foot { display: none; }
    }

    /* ── 반응형 ── */
    @media (max-width: 480px) {
      .body { padding: 28px 20px; }
      .header { padding: 22px 20px; }
      .panel-foot { padding: 14px 20px; }
      .card-box { width: 100px; height: 178px; }
      .card-arena { gap: 20px; }
    }
  </style>
</head>
<body>

<!-- 별빛 -->
<canvas id="starfield"></canvas>

<!-- 배경 오브 -->
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>
<div class="orb orb-3"></div>

<!-- 메인 패널 -->
<div class="panel" id="captureArea">
  <div class="panel-crown"></div>

  <!-- 헤더 -->
  <div class="header">
    <div class="header-symbol">✦ ✦</div>
    <div class="header-brand">
      <div class="brand-main">Jennifer Canvas</div>
      <div class="brand-sub">AI Tarot Reading</div>
    </div>
    <div class="header-gear" onclick="openAdmin()">⚙</div>
  </div>

  <!-- 바디 -->
  <div class="body">

    <!-- ─── 1단계: 입력 ─── -->
    <div id="p1" class="page active">

      <div class="intro-block">
        <img src="https://kang-sd.github.io/taro_images/card_0.webp" class="intro-card-img" alt="타로">
        <div class="intro-text">
          <span class="hl-gold">타로란</span> 상징의 카드로 내면과 감정의 흐름을 비추는 도구입니다.<br>
          <span class="hl-gold">명확하고 구체적인 질문</span>이 <span class="hl-light">타로 해석의 정확도를 높입니다.</span><br>
          당신의 마음이 간절할 때, 방향을 제시합니다.<br><br>
          하루 2회 가능 · 결과 3일 보관<br>
          <span class="hl-gold">총 2장</span>을 선택합니다 — 과정의 흐름 · 최종 결과
        </div>
      </div>

      <div class="field-group">
        <label class="field-label">성함</label>
        <input type="text" id="uName" placeholder="이름을 입력하세요">
      </div>

      <div class="field-group">
        <label class="field-label">상담 주제</label>
        <div class="select-wrap">
          <select id="uTopic">
            <option value="" disabled selected hidden>주제를 선택하세요</option>
            <option>연애</option><option>진로직업</option><option>금전</option>
            <option>감정</option><option>건강</option><option>시험합격</option>
            <option>선택결정</option><option>인간관계</option><option>영적 메시지</option><option>미래 전반</option>
          </select>
        </div>
      </div>

      <div class="field-group">
        <label class="field-label">질문</label>
        <textarea id="uQuest" rows="2" placeholder="마음속의 질문을 적어주세요"></textarea>
      </div>

      <button class="btn-primary" id="startBtn" onclick="checkLimitAndGo()">
        셔플 시작하기
      </button>
    </div>

    <!-- ─── 2단계: 카드 선택 ─── -->
    <div id="p2" class="page">

      <div class="stage-title">
        <h2>운명의 카드를 선택하세요</h2>
        <p>두 장의 카드가 당신의 길을 열어줍니다</p>
      </div>

      <div class="card-arena">
        <div class="card-wrap">
          <div class="card-number">I</div>
          <div id="slot1" class="card-box" onclick="flip(1)"></div>
          <div class="card-label" id="label1">과정의 흐름</div>
        </div>
        <div class="card-wrap">
          <div class="card-number">II</div>
          <div id="slot2" class="card-box" onclick="flip(2)"></div>
          <div class="card-label" id="label2">최종 결과</div>
        </div>
      </div>

      <div class="guide-text" id="guide">첫 번째 카드에 손을 얹으세요</div>

      <button class="btn-primary" id="resBtn" style="display:none;" onclick="go3()">
        운명의 해석 열기
      </button>
    </div>

    <!-- ─── 3단계: 결과 ─── -->
    <div id="p3" class="page">
      <div id="finalOutput">
        <div class="reading-loader">
          <div class="loader-sigil"></div>
          <div class="loader-text">운명의 메시지를 해석하는 중...</div>
        </div>
      </div>
    </div>

  </div><!-- /body -->

  <div class="panel-foot">
    <div class="panel-foot-text">Jennifer Canvas · AI Tarot · Est. 2025</div>
  </div>
</div>

<!-- 관리자 모달 -->
<div id="adminModal">
  <div class="admin-inner">
    <div class="admin-header">
      <div class="admin-title">상담 기록 관리</div>
      <button class="admin-close-btn" onclick="closeAdmin()">닫기</button>
    </div>
    <div id="adminList"></div>
  </div>
</div>

<!-- 결과 모달 -->
<div id="resultModal" onclick="closeResult(event)">
  <div id="resultModalContent" onclick="event.stopPropagation()">
    <button class="modal-close-btn" onclick="closeResult()">×</button>
    <div id="modalResultContent"></div>
  </div>
</div>

<!-- ────────── JS ────────── -->
<script>
/* ── 별빛 파티클 ─────────────────────────────────── */
(function() {
  const canvas = document.getElementById('starfield');
  const ctx    = canvas.getContext('2d');
  let stars    = [];
  const N      = 160;

  function resize() {
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  function init() {
    stars = Array.from({ length: N }, () => ({
      x:    Math.random() * canvas.width,
      y:    Math.random() * canvas.height,
      r:    Math.random() * 0.9 + 0.2,
      a:    Math.random(),
      spd:  Math.random() * 0.004 + 0.001,
      phase: Math.random() * Math.PI * 2
    }));
  }

  function draw(t) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    stars.forEach(s => {
      const alpha = s.a * (0.4 + 0.6 * Math.sin(t * s.spd + s.phase));
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(220,210,190,${alpha})`;
      ctx.fill();
    });
    requestAnimationFrame(draw);
  }

  window.addEventListener('resize', () => { resize(); init(); });
  resize(); init();
  requestAnimationFrame(draw);
})();

/* ── 핵심 로직 ───────────────────────────────────── */
const FN = "https://us-central1-taro-project-624a3.cloudfunctions.net";

const cardMap = Object.fromEntries(
  Array.from({ length: 78 }, (_, i) => [`card_${i}`, `https://kang-sd.github.io/taro_images/card_${i}.webp`])
);
cardMap.back = "https://kang-sd.github.io/taro_images/card_back.webp";

let picks   = [null, null];
let adminPw = null;

async function api(endpoint, body) {
  const res  = await fetch(`${FN}/${endpoint}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || "서버 오류");
  return data;
}

/* ── 1단계 → 2단계 ── */
async function checkLimitAndGo() {
  const name  = document.getElementById('uName').value.trim();
  const topic = document.getElementById('uTopic').value;
  const quest = document.getElementById('uQuest').value.trim();
  if (!name)  { alert("성함을 입력해주세요."); return; }
  if (!topic) { alert("상담 주제를 선택해주세요."); return; }
  if (!quest) { alert("질문을 입력해주세요."); return; }

  const btn = document.getElementById('startBtn');
  btn.disabled = true; btn.textContent = "확인 중...";
  try {
    const { over } = await api("checkLimit", { name });
    if (over) { alert("오늘의 상담 횟수(2회)를 초과하였습니다.\n내일 다시 방문해주세요!"); return; }
    switchPage('p1', 'p2');
  } catch(e) {
    alert("오류: " + e.message);
  } finally {
    btn.disabled = false; btn.textContent = "셔플 시작하기";
  }
}

/* ── 카드 선택 ── */
function flip(n) {
  if (picks[n-1]) return;
  if (n === 2 && !picks[0]) { alert("첫 번째 카드를 먼저 고르세요."); return; }

  const r    = Math.floor(Math.random() * 78);
  picks[n-1] = `card_${r}`;
  const slot = document.getElementById(`slot${n}`);
  slot.style.backgroundImage = `url('${cardMap[picks[n-1]]}')`;
  slot.classList.add('flipped', 'locked');

  const label = document.getElementById(`label${n}`);

  if (n === 1) {
    label.textContent = '과정의 흐름 ✦';
    label.classList.add('chosen');
    document.getElementById('guide').textContent = '두 번째 카드를 선택하세요';
  } else {
    label.textContent = '최종 결과 ✦';
    label.classList.add('chosen');
    const guide = document.getElementById('guide');
    guide.textContent = '두 장의 카드가 선택되었습니다';
    guide.classList.add('ready');
    document.getElementById('resBtn').style.display = 'block';
  }
}

/* ── 2단계 → 3단계 ── */
async function go3() {
  switchPage('p2', 'p3');

  const name  = document.getElementById('uName').value;
  const topic = document.getElementById('uTopic').value;
  const quest = document.getElementById('uQuest').value;

  try {
    const [_, d1, d2] = await Promise.all([
      api("saveLog",     { user: name, topic, quest, cards: picks }),
      api("getCardData", { cardId: picks[0], topic, type: "과정" }),
      api("getCardData", { cardId: picks[1], topic, type: "결과" })
    ]);
    document.getElementById('finalOutput').innerHTML = generateResultHTML(name, picks, [d1, d2]);
  } catch(e) {
    document.getElementById('finalOutput').innerHTML =
      `<div style="text-align:center;padding:40px;color:#e08080;font-style:italic;">오류: ${e.message}</div>`;
  }
}

/* ── 결과 HTML 생성 ── */
function generateResultHTML(userName, cards, cardData) {
  const posMax = 100, negMax = 100;

  let html = `
    <div class="result-header">
      <div class="result-header-eyebrow">타로 리딩 결과</div>
      <div class="result-header-name">${userName}<span>님의 운명</span></div>
    </div>`;

  cardData.forEach((d, i) => {
    const pos     = parseInt(d.pos) || 0;
    const neg     = parseInt(d.neg) || 0;
    const posW    = Math.min((pos / posMax) * 100, 100);
    const negW    = Math.min((neg / negMax) * 100, 100);
    const posLabel = i === 0 ? '과정의 흐름' : '최종 결과';

    html += `
      <div class="res-card">
        <div class="res-card-top">
          <img src="${cardMap[cards[i]]}" class="res-img" alt="${d.name}">
          <div class="res-card-meta">
            <div class="res-position">${posLabel}</div>
            <div class="res-name">${d.name}</div>
            <div class="res-key">${d.key}</div>
          </div>
        </div>

        <div class="res-section">
          <div class="res-section-label">카드의 서사</div>
          <div class="res-section-body">${d.story}</div>
        </div>

        <div class="res-section">
          <div class="res-section-label">운명의 해석</div>
          <div class="res-section-body emphasis">${d.txt}</div>
        </div>

        <div class="res-section">
          <div class="res-section-label">에너지 흐름</div>
          <div style="margin-top:4px;">
            <div class="score-row">
              <span style="font-size:0.72rem;color:var(--faint);width:40px;">긍정</span>
              <div class="score-bar-wrap"><div class="score-bar" style="width:${posW}%"></div></div>
              <div class="score-pct">${d.pos}</div>
            </div>
            <div class="score-row" style="margin-top:8px;">
              <span style="font-size:0.72rem;color:var(--faint);width:40px;">경계</span>
              <div class="score-bar-wrap"><div class="score-bar neg" style="width:${negW}%"></div></div>
              <div class="score-pct">${d.neg}</div>
            </div>
          </div>
        </div>

        <div class="res-section">
          <div class="res-section-label">감정의 결</div>
          <div class="res-section-body">
            <span class="tone-pill">${d.tone}</span>
            <span style="display:block;margin-top:10px;">${d.desc}</span>
          </div>
        </div>

        <div class="res-section">
          <div class="res-section-label">조언</div>
          <div class="res-section-body">
            <div class="advice-pos">✦ 긍정적 측면</div>
            <div style="margin:6px 0 12px; color:#aaaac0; font-size:0.88rem; line-height:1.75;">${d.posA}</div>
            <div class="advice-neg">✦ 주의할 점</div>
            <div style="margin:6px 0 0; color:#aaaac0; font-size:0.88rem; line-height:1.75;">${d.negA}</div>
          </div>
        </div>
      </div>`;
  });

  html += `
    <div class="result-actions">
      <button class="btn-primary" onclick="window.print()">결과 저장 (PDF)</button>
      <button class="btn-ghost"   onclick="location.reload()">처음으로 돌아가기</button>
    </div>`;

  return html;
}

/* ── 페이지 전환 ── */
function switchPage(from, to) {
  document.getElementById(from).classList.remove('active');
  document.getElementById(to).classList.add('active');
}

/* ── 관리자 ── */
async function openAdmin() {
  const pw = prompt("관리자 비밀번호");
  if (!pw) return;
  document.getElementById('adminModal').style.display = 'block';
  document.getElementById('adminList').innerHTML =
    `<div style="text-align:center;padding:40px;color:var(--faint);font-style:italic;">기록을 불러오는 중...</div>`;
  try {
    const { logs } = await api("adminGetLogs", { password: pw });
    adminPw = pw;
    if (!logs.length) {
      document.getElementById('adminList').innerHTML =
        `<div style="text-align:center;padding:40px;color:var(--faint);font-style:italic;">기록이 없습니다</div>`;
      return;
    }
    let html = "";
    logs.forEach(d => {
      html += `
        <div class="admin-record">
          <div class="admin-record-name">${d.user}</div>
          <div class="admin-record-info">주제: ${d.topic} &nbsp;·&nbsp; 질문: ${d.quest}</div>
          <div class="admin-record-time">${d.timeStr}</div>
          <button onclick='viewResult(${JSON.stringify(d)})' class="admin-btn btn-view">결과 보기</button>
          <button onclick="delLog('${d.id}')" class="admin-btn btn-delete">삭제</button>
        </div>`;
    });
    document.getElementById('adminList').innerHTML = html;
  } catch(e) {
    document.getElementById('adminList').innerHTML =
      `<div style="color:#e08080;padding:20px;">${e.message === "인증 실패" ? "비밀번호가 올바르지 않습니다." : "오류: " + e.message}</div>`;
  }
}

function closeAdmin() { document.getElementById('adminModal').style.display = 'none'; }

async function viewResult(data) {
  document.getElementById('resultModal').style.display = 'block';
  document.getElementById('modalResultContent').innerHTML =
    `<div style="text-align:center;padding:50px;color:var(--faint);font-style:italic;">해석 중...</div>`;
  try {
    const { user, topic, quest, cards } = data;
    if (!cards || cards.length < 2) throw new Error("카드 정보 없음");
    const [d1, d2] = await Promise.all([
      api("getCardData", { cardId: cards[0], topic, type: "과정" }),
      api("getCardData", { cardId: cards[1], topic, type: "결과" })
    ]);
    document.getElementById('modalResultContent').innerHTML = generateResultHTML(user, cards, [d1, d2]);
  } catch(e) {
    document.getElementById('modalResultContent').innerHTML =
      `<div style="color:#e08080;padding:20px;">오류: ${e.message}</div>`;
  }
}

function closeResult(event) {
  if (!event || event.target.id === 'resultModal')
    document.getElementById('resultModal').style.display = 'none';
}

async function delLog(id) {
  if (!confirm("이 기록을 삭제하시겠습니까?")) return;
  try {
    await api("adminDeleteLog", { password: adminPw, id });
    alert("삭제되었습니다.");
    openAdmin();
  } catch(e) { alert("삭제 실패: " + e.message); }
}
</script>
</body>
</html>

